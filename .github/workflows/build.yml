name: Build & Release

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Import Code Signing Certificate
        env:
          CERTIFICATE_P12: ${{ secrets.CERTIFICATE_P12 }}
          CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
        run: |
          echo "$CERTIFICATE_P12" | base64 --decode > /tmp/cert.p12
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security import /tmp/cert.p12 -k build.keychain -P "$CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
          security add-trusted-cert -d -r trustRoot -p codeSign -k build.keychain /tmp/cert.p12 2>/dev/null || true
          rm /tmp/cert.p12

      - name: Build (ARM64)
        run: swift build -c release --arch arm64 2>&1
        env:
          MACOSX_DEPLOYMENT_TARGET: '13.0'

      - name: Build (x86_64)
        run: swift build -c release --arch x86_64 2>&1
        env:
          MACOSX_DEPLOYMENT_TARGET: '13.0'

      - name: Create Universal Binary
        run: |
          lipo -create \
            .build/arm64-apple-macosx/release/ReTyper \
            .build/x86_64-apple-macosx/release/ReTyper \
            -output ReTyper-universal
          file ReTyper-universal

      - name: Create .app bundle
        run: |
          APP_DIR="ReTyper.app"
          MACOS_DIR="$APP_DIR/Contents/MacOS"
          mkdir -p "$MACOS_DIR"
          cp ReTyper-universal "$MACOS_DIR/ReTyper"
          git checkout HEAD -- ReTyper.app/Contents/Info.plist
          codesign --force --sign "ReTyper Dev" "$APP_DIR"

      - name: Verify build
        run: |
          echo "✅ Build artifacts:"
          ls -la ReTyper.app/Contents/MacOS/
          file ReTyper.app/Contents/MacOS/ReTyper
          lipo -info ReTyper.app/Contents/MacOS/ReTyper

      - name: Create DMG
        run: |
          mkdir -p dmg_contents
          cp -R ReTyper.app dmg_contents/
          hdiutil create -volname "ReTyper" -srcfolder dmg_contents -ov -format UDZO ReTyper-macOS-universal.dmg

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ReTyper-macOS-universal
          path: ReTyper-macOS-universal.dmg

  release:
    needs: build
    runs-on: macos-14
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Import Code Signing Certificate
        env:
          CERTIFICATE_P12: ${{ secrets.CERTIFICATE_P12 }}
          CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
        run: |
          echo "$CERTIFICATE_P12" | base64 --decode > /tmp/cert.p12
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security import /tmp/cert.p12 -k build.keychain -P "$CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
          rm /tmp/cert.p12

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install semantic-release
        run: npm install -g semantic-release @semantic-release/commit-analyzer @semantic-release/release-notes-generator @semantic-release/github @semantic-release/exec conventional-changelog-conventionalcommits

      - name: Build (ARM64)
        run: swift build -c release --arch arm64 2>&1
        env:
          MACOSX_DEPLOYMENT_TARGET: '13.0'

      - name: Build (x86_64)
        run: swift build -c release --arch x86_64 2>&1
        env:
          MACOSX_DEPLOYMENT_TARGET: '13.0'

      - name: Create Universal Binary
        run: |
          lipo -create \
            .build/arm64-apple-macosx/release/ReTyper \
            .build/x86_64-apple-macosx/release/ReTyper \
            -output ReTyper-universal

      - name: Create .app bundle
        run: |
          APP_DIR="ReTyper.app"
          MACOS_DIR="$APP_DIR/Contents/MacOS"
          mkdir -p "$MACOS_DIR"
          cp ReTyper-universal "$MACOS_DIR/ReTyper"
          git checkout HEAD -- ReTyper.app/Contents/Info.plist
          codesign --force --sign "ReTyper Dev" "$APP_DIR"

      - name: Create DMG
        run: |
          mkdir -p dmg_contents
          cp -R ReTyper.app dmg_contents/
          hdiutil create -volname "ReTyper" -srcfolder dmg_contents -ov -format UDZO ReTyper-macOS-universal.dmg

      - name: Create ZIP
        run: zip -r ReTyper-macOS-universal.zip ReTyper.app

      - name: Semantic Release
        id: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GIT_AUTHOR_NAME: Jarvis
          GIT_AUTHOR_EMAIL: jarvis.max.dev@proton.me
          GIT_COMMITTER_NAME: Jarvis
          GIT_COMMITTER_EMAIL: jarvis.max.dev@proton.me
        run: npx semantic-release

      - name: Update Homebrew Cask
        if: hashFiles('.version') != ''
        env:
          TAP_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          VERSION=$(cat .version)
          SHA256=$(shasum -a 256 ReTyper-macOS-universal.dmg | awk '{print $1}')
          echo "Updating Cask to v${VERSION} (sha256: ${SHA256})"

          git clone https://${TAP_TOKEN}@github.com/JarvisMaxDev/homebrew-tap.git /tmp/tap
          cd /tmp/tap

          cat > Casks/retyper.rb << EOF
          cask "retyper" do
            version "${VERSION}"
            sha256 "${SHA256}"

            url "https://github.com/JarvisMaxDev/ReTyper/releases/download/v#{version}/ReTyper-macOS-universal.dmg"
            name "ReTyper"
            desc "macOS keyboard layout switcher — convert mistyped text between Latin and Cyrillic"
            homepage "https://github.com/JarvisMaxDev/ReTyper"

            depends_on macos: ">= :ventura"

            app "ReTyper.app"

            zap trash: [
              "~/Library/Preferences/com.retyper.app.plist",
            ]
          end
          EOF

          git config user.name "Jarvis"
          git config user.email "jarvis.max.dev@proton.me"
          git add Casks/retyper.rb
          git commit -m "chore: update ReTyper cask to v${VERSION}"
          git push
